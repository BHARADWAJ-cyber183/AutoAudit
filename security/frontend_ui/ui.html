<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AutoAudit – Evidence Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Brand fonts -->
  <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --royal:#072576;     /* Royal Blue */
      --teal:#64DFDF;      /* Teal */
      --ink:#111827;
      --muted:#6b7280;
      --bg:#f9fafb;
      --border:#e5e7eb;
      --card:#ffffff;
      --ok:#047857;
      --bad:#b00020;
      --focus: 0 0 0 3px rgba(100,223,223,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background:#fff;
      font:16px/1.45 Helvetica, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:1060px;margin:40px auto;padding:0 20px}

    /* ===== Brand header ===== */
    .brand{margin-bottom:12px}
    .wordmark{
      font-family:"League Spartan", Helvetica, Arial, sans-serif;
      font-weight:800;
      letter-spacing:.25px;
      line-height:1.0;
      font-size:48px;
      display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;
    }
    .wordmark span{display:inline-block}
    .au-blue{color:var(--royal)}
    .teal{color:var(--teal)}
    .product{
      margin:.25rem 0 1rem 0;
      color:var(--muted);
      font-weight:600;
      font-size:18px;
      letter-spacing:.2px;
      font-family:"League Spartan", Helvetica, Arial, sans-serif;
    }
    @media (max-width:720px){
      .wordmark{font-size:40px}
    }

    /* ===== Cards & layout ===== */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      margin-top:18px;
      box-shadow:0 1px 0 rgba(17,24,39,.02);
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:800px){ .row{grid-template-columns:1fr} }

    label{display:block;margin:8px 0 6px;font-weight:700;color:var(--royal)}
    select,input[type=text],input[type=file]{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size:15px;
      outline:none;
    }
    select:focus,input:focus{box-shadow:var(--focus);border-color:var(--teal)}

    .help{color:var(--muted);font-size:13px;margin-top:6px}
    .hidden{display:none}

    button{
      padding:11px 16px;
      border:0;border-radius:10px;
      background:linear-gradient(90deg,var(--royal),var(--teal));
      color:#fff;font-weight:800;
      font-family:"League Spartan", Helvetica, Arial, sans-serif;
      letter-spacing:.2px;
      cursor:pointer;
      transition:filter .15s ease;
    }
    button:hover{filter:brightness(1.05)}
    button[disabled]{opacity:.6;cursor:not-allowed;filter:none}

    .error{color:var(--bad);margin-top:8px}

    /* ===== Results ===== */
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid var(--border);padding:10px;vertical-align:top;font-size:14px}
    th{background:var(--bg);text-align:left}
    .ok{color:var(--ok);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand" aria-label="AutoAudit Evidence Scanner">
      <div class="wordmark">
        <span class="au-blue">AU<span class="teal">TO</span>
        <div></div>
        <span class="teal">AU<span class="au-blue">DIT</span>
      </div>
      <h2 class="product">Evidence Scanner</h2>
    </div>

    <p class="help" style="margin:0 0 6px 2px;">
      Pick a strategy, then upload a file. Images, PDF, DOCX, TXT, logs, registry exports are supported.
    </p>

    <div class="card">
      <div class="row">
        <div>
          <label for="strategy">Strategy</label>
          <select id="strategy" aria-label="Select strategy"></select>
          <div id="strategyDesc" class="help"></div>
        </div>
        <div>
          <label for="user">User ID (optional)</label>
          <input id="user" type="text" placeholder="e.g. bharadwaj" />
        </div>
      </div>

      <div style="margin-top:14px;">
        <label for="file">Evidence file</label>
        <input id="file" type="file" disabled
               accept=".pdf,.png,.jpg,.jpeg,.tif,.tiff,.bmp,.webp,.txt,.docx,.csv,.log,.reg,.ini,.json,.xml,.htm,.html" />
        <div class="help">Enabled after you choose a strategy.</div>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; align-items:center;">
        <button id="scanBtn" disabled>Scan Evidence</button>
        <span id="busy" class="help hidden">Scanning…</span>
        <span id="err" class="error"></span>
      </div>
    </div>

    <div id="results" class="card hidden">
      <h3 style="margin:0 0 8px 0;font-family:'League Spartan',Helvetica,Arial,sans-serif;color:var(--royal)">Results</h3>
      <div id="meta" class="help"></div>
      <div id="noFindings" class="help hidden">No readable text found or no findings.</div>
      <table id="rowsTable" class="hidden">
        <thead>
          <tr>
            <th>Test ID</th>
            <th>Sub-Strategy</th>
            <th>Level</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Recommendation</th>
            <th>Evidence Extract</th>
            <th>Report</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = location.origin;

    const els = {
      strategy: document.getElementById('strategy'),
      strategyDesc: document.getElementById('strategyDesc'),
      user: document.getElementById('user'),
      file: document.getElementById('file'),
      scanBtn: document.getElementById('scanBtn'),
      busy: document.getElementById('busy'),
      err: document.getElementById('err'),
      results: document.getElementById('results'),
      meta: document.getElementById('meta'),
      noFindings: document.getElementById('noFindings'),
      rowsTable: document.getElementById('rowsTable'),
      tbody: document.querySelector('#rowsTable tbody'),
    };

    async function loadStrategies() {
      const res = await fetch(`${API_BASE}/strategies`);
      const list = await res.json(); // [{name, description}]
      els.strategy.innerHTML = `<option value="" disabled selected>— select a strategy —</option>`;
      list.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.name;
        opt.textContent = s.name;
        opt.dataset.desc = s.description || '';
        els.strategy.appendChild(opt);
      });
    }

    function onStrategyChange() {
      const opt = els.strategy.options[els.strategy.selectedIndex];
      const desc = opt?.dataset?.desc || '';
      els.strategyDesc.textContent = desc;
      const hasChoice = !!els.strategy.value;
      els.file.disabled = !hasChoice;
      els.scanBtn.disabled = !hasChoice;
      els.err.textContent = '';
    }

    async function scan() {
      els.err.textContent = '';
      const strategy = els.strategy.value;
      const user = els.user.value || 'user';
      const file = els.file.files[0];

      if (!strategy) { els.err.textContent = 'Select a strategy.'; return; }
      if (!file) { els.err.textContent = 'Choose an evidence file.'; return; }

      const fd = new FormData();
      fd.append('strategy_name', strategy);
      fd.append('user_id', user);
      fd.append('evidence', file);

      els.scanBtn.disabled = true;
      els.busy.classList.remove('hidden');

      try {
        const res = await fetch(`${API_BASE}/scan`, { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.detail || 'Scan failed');
        renderResults(strategy, file.name, data);
      } catch (e) {
        els.err.textContent = e.message || 'Scan failed';
      } finally {
        els.scanBtn.disabled = false;
        els.busy.classList.add('hidden');
      }
    }

    function renderResults(strategy, filename, data) {
      els.results.classList.remove('hidden');
      els.meta.innerHTML = `
        <div><span class="tag">Strategy</span> ${strategy}</div>
        <div><span class="tag">File</span> ${filename}</div>
      `;

      const findings = data?.findings || [];
      const reports = data?.reports || [];
      els.tbody.innerHTML = '';

      if (!findings.length) {
        els.noFindings.classList.remove('hidden');
        els.rowsTable.classList.add('hidden');
        return;
      }
      els.noFindings.classList.add('hidden');
      els.rowsTable.classList.remove('hidden');

      findings.forEach((r, i) => {
        const tr = document.createElement('tr');
        const status = (r.pass_fail || '').toUpperCase();
        const statusClass = status === 'PASS' ? 'ok' : status === 'FAIL' ? 'bad' : '';
        const reportFile = reports[i] ? `${API_BASE}/reports/${encodeURIComponent(reports[i])}` : '';

        tr.innerHTML = `
          <td>${r.test_id || ''}</td>
          <td>${r.sub_strategy || ''}</td>
          <td>${r.detected_level || ''}</td>
          <td class="${statusClass}">${r.pass_fail || ''}</td>
          <td>${r.priority || ''}</td>
          <td>${r.recommendation || ''}</td>
          <td>${Array.isArray(r.evidence) ? r.evidence.join('<br>') : ''}</td>
          <td>${reportFile ? `<a href="${reportFile}" target="_blank" rel="noopener">PDF</a>` : ''}</td>
        `;
        els.tbody.appendChild(tr);
      });
    }

    els.strategy.addEventListener('change', onStrategyChange);
    els.scanBtn.addEventListener('click', scan);
    loadStrategies();
  </script>
</body>
</html>
